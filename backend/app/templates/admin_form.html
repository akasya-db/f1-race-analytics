<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% if record %}Edit{% else %}Create{% endif %} {{ table_info.display_name }} - Admin Panel | F1 Race Analytics</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&family=Montserrat:wght@700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
</head>
<body>
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="flash-messages">
        {% for message in messages %}
          <div class="flash-message {% if 'error' in message|lower or 'failed' in message|lower %}error{% endif %}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <header class="nav" aria-label="Primary">
    <a href="{{ url_for('auth.index') }}" class="brand" aria-label="F1 Race Analytics">
      <div class="logo" aria-hidden="true"></div>
      <span>F1 Race Analytics</span>
    </a>
    <nav class="menu" aria-label="Main menu">
      <a href="{{ url_for('admin.admin_panel') }}">Admin Panel</a>
      <a href="{{ url_for('admin.admin_table_list', table_name=table_name) }}">Back to {{ table_info.name }}</a>
      <a href="{{ url_for('auth.logout') }}">Logout</a>
    </nav>
  </header>

  <div class="admin-container">
    <div class="admin-header">
      <h1>{% if record %}Edit{% else %}Create New{% endif %} {{ table_info.display_name }}</h1>
      <p>{% if record %}Update the record details below{% else %}Fill in the form to create a new record{% endif %}</p>
    </div>

    <form method="POST" class="admin-form">
      {% for col in schema %}
        {% set col_name = col.name %}
        {% set is_fk = col_name in foreign_keys %}
        {% set is_auto = (col_name == 'id' and col.default and 'nextval' in col.default|string) or col_name == 'created_at' %}
        
        {% if not is_auto %}
        <div class="form-group">
          <label for="{{ col_name }}">
            {{ col_name|replace('_', ' ')|title }}
            {% if not col.nullable %}<span style="color: var(--f1-red);">*</span>{% endif %}
          </label>
          
          {% if is_fk %}
            {# Foreign key dropdown #}
            {% set fk_table = foreign_keys[col_name]['table'] %}
            {% set fk_options = fk_options.get(col_name, []) %}
            <select id="{{ col_name }}" name="{{ col_name }}" {% if not col.nullable %}required{% endif %}>
              <option value="">-- Select {{ fk_table|replace('_', ' ')|title }} --</option>
              {% for option in fk_options %}
              <option value="{{ option.id }}" {% if record and record[col_name] == option.id %}selected{% endif %}>
                {{ option.display }}
              </option>
              {% endfor %}
            </select>
          {% elif col.type == 'boolean' %}
            {# Boolean checkbox #}
            <select id="{{ col_name }}" name="{{ col_name }}">
              <option value="true" {% if record and record[col_name] %}selected{% endif %}>True</option>
              <option value="false" {% if not record or not record[col_name] %}selected{% endif %}>False</option>
            </select>
          {% elif col.type in ['timestamp without time zone', 'timestamp with time zone', 'date'] %}
            {# Date/DateTime input #}
            {% if record and record[col_name] %}
              {% if col.type == 'date' %}
                <input type="date" id="{{ col_name }}" name="{{ col_name }}" value="{{ record[col_name].strftime('%Y-%m-%d') if record[col_name] else '' }}" {% if not col.nullable %}required{% endif %} />
              {% else %}
                <input type="datetime-local" id="{{ col_name }}" name="{{ col_name }}" value="{{ record[col_name].strftime('%Y-%m-%dT%H:%M') if record[col_name] else '' }}" {% if not col.nullable %}required{% endif %} />
              {% endif %}
            {% else %}
              {% if col.type == 'date' %}
                <input type="date" id="{{ col_name }}" name="{{ col_name }}" {% if not col.nullable %}required{% endif %} />
              {% else %}
                <input type="datetime-local" id="{{ col_name }}" name="{{ col_name }}" {% if not col.nullable %}required{% endif %} />
              {% endif %}
            {% endif %}
          {% elif col.type in ['integer', 'bigint', 'smallint'] %}
            {# Integer input #}
            <input type="number" id="{{ col_name }}" name="{{ col_name }}" value="{{ record[col_name] if record and record[col_name] is not none else '' }}" {% if not col.nullable %}required{% endif %} step="1" />
          {% elif col.type in ['numeric', 'decimal', 'real', 'double precision'] %}
            {# Decimal input #}
            <input type="number" id="{{ col_name }}" name="{{ col_name }}" value="{{ record[col_name] if record and record[col_name] is not none else '' }}" {% if not col.nullable %}required{% endif %} step="any" />
          {% elif col_name == 'password' and table_name == 'user' %}
            {# Password field for user table #}
            <input type="password" id="{{ col_name }}" name="{{ col_name }}" placeholder="{% if record %}Leave empty to keep current password{% else %}Enter password{% endif %}" {% if not record and not col.nullable %}required{% endif %} />
          {% elif col.type == 'text' or (col.type == 'character varying' and not col_name.endswith('_id')) %}
            {# Text input or textarea for long text #}
            {% if col_name in ['previous_names', 'full_name'] or 'description' in col_name %}
              <textarea id="{{ col_name }}" name="{{ col_name }}" rows="3" {% if not col.nullable %}required{% endif %}>{{ record[col_name] if record and record[col_name] is not none else '' }}</textarea>
            {% else %}
              <input type="text" id="{{ col_name }}" name="{{ col_name }}" value="{{ record[col_name] if record and record[col_name] is not none else '' }}" {% if not col.nullable %}required{% endif %} />
            {% endif %}
          {% else %}
            {# Default text input #}
            <input type="text" id="{{ col_name }}" name="{{ col_name }}" value="{{ record[col_name] if record and record[col_name] is not none else '' }}" {% if not col.nullable %}required{% endif %} />
          {% endif %}
          
          <p class="info-text">
            Type: {{ col.type }}
            {% if col.nullable %}(Optional){% else %}(Required){% endif %}
          </p>
        </div>
        {% endif %}
      {% endfor %}

      <div class="form-actions">
        <button type="submit" class="btn btn-primary">
          {% if record %}Update{% else %}Create{% endif %} {{ table_info.display_name }}
        </button>
        <a href="{{ url_for('admin.admin_table_list', table_name=table_name) }}" class="btn btn-secondary">Cancel</a>
      </div>
    </form>
  </div>

  <script>
    // Auto-remove flash messages after 4 seconds
    document.addEventListener('DOMContentLoaded', function() {
      const flashMessages = document.querySelectorAll('.flash-message');
      flashMessages.forEach(function(message) {
        setTimeout(function() {
          message.remove();
        }, 4000);
      });
    });
  </script>
</body>
</html>

