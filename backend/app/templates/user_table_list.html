<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ title }} | F1 Race Analytics</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&family=Montserrat:wght@700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/add_data.css') }}">
</head>
<body>
  {% include "navbar.html" %}

  <div class="panel-container"> 
    <div class="panel-header"> 
      <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
        <div>
          <h1>{{ title }}</h1>
          <p>{{ records|length }} custom records found</p>
        </div>
        
        {% if title == "My Constructors" %}
          <a href="{{ url_for('constructors.add_constructor_page') }}" class="btn-panel btn-panel-primary">
            + Add New Constructor
          </a>

        {% elif title == "My Races" %}
          <a href="{{ url_for('races.add_race_form_page') }}" class="btn-panel btn-panel-primary">
            + Add New Race
          </a>

        {% elif title == "My Race Data" %}
          <a href="{{ url_for('races.add_race_data_form_page') }}" class="btn-panel btn-panel-primary">
            + Add New Race Data
          </a>

        {% elif title == "My Drivers" %}
          <a href="{{ url_for('drivers.add_driver_form_page') }}" class="btn-panel btn-panel-primary">
            + Add New Driver
          </a>
        {% endif %}

      </div>
    </div>

    {% if records %}
    <div class="table-wrapper">
      <table class="panel-table">
        <thead>
          <tr>
            {% if title == "My Race Data" %}
              <th>Race</th>
              <th>Driver</th>
              <th>Constructor</th>
              <th>Position</th>
              <th>Number</th>
              <th>Points</th>
              <th>Pole</th>
              <th>Qual Pos</th>
              <th>Grid Pos</th>
              <th>Created</th>
              <th>Actions</th>
            {% else %}
              {% for col in schema %}
                {% if col not in ['id', 'is_real', 'user_id', 'name', 'circuit_id'] %}
                  <th>
                    {% if col == 'country_id' %}Country
                    {% elif col == 'full_name' %}Name
                    {% elif col == 'circuit_name' %}Circuit
                    {% elif col == 'official_name' %}Race Name
                    {% else %}{{ col|replace('_', ' ')|title }}
                    {% endif %}
                  </th>
                {% endif %}
              {% endfor %}
              <th>Actions</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for record in records %}
          <tr>
            {% if title == "My Race Data" %}
              <td>{{ record.race_name or '-' }}</td>
              <td>{{ record.driver_name or '-' }}</td>
              <td>{{ record.constructor_name or '-' }}</td>
              <td>{{ record.position_display_order or '-' }}</td>
              <td>{{ record.driver_number or '-' }}</td>
              <td>{{ record.race_points or '-' }}</td>
              <td>{{ 'Yes' if record.race_pole_position else 'No' }}</td>
              <td>{{ record.race_qualification_position_number or '-' }}</td>
              <td>{{ record.race_grid_position_number or '-' }}</td>
              <td>{{ record.created_at }}</td>
              <td class="actions-cell">
                <a href="{{ url_for('races.edit_race_data_form_page', race_data_id=record['id']) }}" class="btn-icon btn-edit" title="Edit">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                  </svg>
                </a>
                <button class="btn-icon btn-delete delete-trigger" title="Delete" data-id="{{ record.id }}" data-name="{{ record.driver_name }} - {{ record.race_name }}" data-type="race_data">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                  </svg>
                </button>
              </td>
            {% else %}
              {% for col in schema %}
                {% if col not in ['id', 'is_real', 'user_id', 'name', 'circuit_id'] %}
                  <td>
                    {% if record[col] is none %}
                      <span style="opacity: 0.5;">-</span>
                    {% else %}
                      {{ record[col]|string|truncate(40) }}
                    {% endif %}
                  </td>
                {% endif %}
              {% endfor %}
              <td class="actions-cell">
                {% if title == "My Constructors" %}
                  <a href="{{ url_for('constructors.edit_constructor_page', constructor_id=record['id']) }}" class="btn-icon btn-edit" title="Edit">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                  </a>
                {% elif title == "My Races" %}
                  <a href="{{ url_for('races.edit_race_form_page', race_id=record['id']) }}" class="btn-icon btn-edit" title="Edit">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                  </a>
                  {% elif title == "My Drivers" %}
                  <a href="{{ url_for('drivers.edit_driver_form_page', driver_id=record['id']) }}"
                    class="btn-icon btn-edit" title="Edit">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14 a2 2 0 0 0 2 2h14 a2 2 0 0 0 2-2v-7"></path>
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3 L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                  </a>

                {% endif %}
                <button class="btn-icon btn-delete delete-trigger" title="Delete" data-id="{{ record.id }}" data-name="{{ record.official_name if title == 'My Races' else record.name }}" data-type="{{ 'race' if title == 'My Races' else 'constructor' }}">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                  </svg>
                </button>
              </td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="empty-state">
      {% if title == "My Constructors" %}
        <p style="color: var(--f1-grey); font-size: 18px; margin-bottom: 24px;">You haven't added any custom constructors yet.</p>
      {% elif title == "My Races" %}
        <p style="color: var(--f1-grey); font-size: 18px; margin-bottom: 24px;">You haven't added any custom races yet.</p>
      {% elif title == "My Race Data" %}
        <p style="color: var(--f1-grey); font-size: 18px; margin-bottom: 24px;">You haven't added any custom race data yet.</p>
      {% endif %}
    </div>
    {% endif %}
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          </svg>
        </div>
        <h3 class="modal-title">Confirm Delete</h3>
      </div>
      <div class="modal-body">
        <div class="modal-item-name" id="modalItemName"></div>
        <div class="modal-warning">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
            <line x1="12" y1="9" x2="12" y2="13"></line>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
          </svg>
          <span id="modalWarningText"></span>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="modal-btn modal-btn-cancel" id="modalCancel">Cancel</button>
        <button type="button" class="modal-btn modal-btn-delete" id="modalConfirm">Delete</button>
      </div>
    </div>
  </div>

  <style>
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(7, 9, 12, 0.85);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .modal-content {
      background: linear-gradient(135deg, #0f151c 0%, #1a2128 50%, #0d1116 100%);
      border: 1px solid rgba(255, 30, 21, 0.3);
      border-radius: 20px;
      padding: 32px;
      max-width: 480px;
      width: 90%;
      box-shadow: 0 24px 48px rgba(0, 0, 0, 0.6), 0 0 60px rgba(255, 30, 21, 0.15);
      transform: scale(0.9) translateY(-20px);
      transition: transform 0.3s ease;
    }
    .modal-overlay.active .modal-content {
      transform: scale(1) translateY(0);
    }
    .modal-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    .modal-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--f1-red), #c20f09);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .modal-icon svg {
      width: 24px;
      height: 24px;
      color: white;
    }
    .modal-title {
      font-family: Montserrat, Poppins, sans-serif;
      font-size: 20px;
      font-weight: 800;
      color: var(--f1-white);
      margin: 0;
    }
    .modal-body {
      margin-bottom: 28px;
    }
    .modal-item-name {
      background: rgba(255, 30, 21, 0.1);
      border: 1px solid rgba(255, 30, 21, 0.2);
      border-radius: 10px;
      padding: 12px 16px;
      margin-bottom: 16px;
      font-weight: 600;
      color: var(--f1-white);
      word-break: break-word;
    }
    .modal-warning {
      background: rgba(255, 208, 56, 0.1);
      border: 1px solid rgba(255, 208, 56, 0.3);
      border-radius: 10px;
      padding: 14px 16px;
      color: var(--f1-yellow);
      font-size: 14px;
      line-height: 1.5;
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }
    .modal-warning svg {
      flex-shrink: 0;
      margin-top: 2px;
    }
    .modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    .modal-btn {
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      font-family: inherit;
    }
    .modal-btn-cancel {
      background: rgba(169, 189, 209, 0.1);
      border: 1px solid rgba(169, 189, 209, 0.3);
      color: var(--f1-grey);
    }
    .modal-btn-cancel:hover {
      background: rgba(169, 189, 209, 0.2);
      color: var(--f1-white);
    }
    .modal-btn-delete {
      background: linear-gradient(135deg, var(--f1-red), #c20f09);
      color: white;
      box-shadow: 0 4px 12px rgba(255, 30, 21, 0.3);
    }
    .modal-btn-delete:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255, 30, 21, 0.4);
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const deleteButtons = document.querySelectorAll('.delete-trigger');
      const modal = document.getElementById('deleteModal');
      const modalItemName = document.getElementById('modalItemName');
      const modalWarningText = document.getElementById('modalWarningText');
      const modalCancel = document.getElementById('modalCancel');
      const modalConfirm = document.getElementById('modalConfirm');

      const cascadeWarnings = {
        'race': 'This will also delete all related race data, driver standings, and constructor standings for this race.',
        'constructor': 'This will also delete all race data entries that reference this constructor.',
        'race_data': 'This race data entry will be permanently deleted.',
        'driver': 'This will also delete all race data and standings entries for this driver.'
      };

      let pendingDelete = null;

      deleteButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          const id = this.getAttribute('data-id');
          const name = this.getAttribute('data-name');
          const type = this.getAttribute('data-type');

          pendingDelete = { id, name, type };
          modalItemName.textContent = name;
          const warning = cascadeWarnings[type] || 'This record will be permanently deleted.';
          modalWarningText.textContent = warning + ' This action cannot be undone.';
          modal.classList.add('active');
        });
      });

      modalCancel.addEventListener('click', () => {
        modal.classList.remove('active');
        pendingDelete = null;
      });

      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('active');
          pendingDelete = null;
        }
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
          modal.classList.remove('active');
          pendingDelete = null;
        }
      });

      modalConfirm.addEventListener('click', async () => {
        if (!pendingDelete) return;
        const { id, type } = pendingDelete;

        let apiUrl;
        if (type === 'race') apiUrl = '/api/delete-race/' + id;
        else if (type === 'constructor') apiUrl = '/api/delete-constructor/' + id;
        else if (type === 'race_data') apiUrl = '/api/delete-race-data/' + id;
        else if (type === 'driver') apiUrl = '/api/delete-driver/' + id;
        else apiUrl = '/api/delete';

        try {
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          const result = await response.json();
          if (result.success) {
            showToast('Record deleted successfully', 'success');
            setTimeout(() => location.reload(), 1000);
          } else {
            modal.classList.remove('active');
            showToast('Error: ' + result.error, 'error');
          }
        } catch (err) {
          console.error('Delete failed:', err);
          modal.classList.remove('active');
          showToast('Failed to connect to the server.', 'error');
        }
      });

      // Toast notification function
      function showToast(message, type = 'success') {
        let container = document.querySelector('.toast-container');
        if (!container) {
          container = document.createElement('div');
          container.className = 'toast-container';
          document.body.appendChild(container);
        }
        
        const toast = document.createElement('div');
        toast.className = 'toast ' + type;
        toast.textContent = message;
        container.appendChild(toast);

        setTimeout(() => {
          toast.classList.add('hiding');
          setTimeout(() => toast.remove(), 300);
        }, 4000);
      }
    });
  </script>
  <script src="{{ url_for('static', filename='js/navbar.js') }}"></script>
</body>
</html>
